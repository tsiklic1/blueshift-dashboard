name: Deploy
on:
  push:
    branches:
      - "**"
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
jobs:
  deploy:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # https://github.com/actions/checkout/releases/tag/v6.0.0
        with:
          fetch-depth: 2

      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # https://github.com/pnpm/action-setup/releases/tag/v4.2.0
        with:
          version: 10
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # https://github.com/actions/setup-node/releases/tag/v6.0.0
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Cache Next.js
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # https://github.com/actions/cache/releases/tag/v4.3.0
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-

      - name: Cache Compiled MDX
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # https://github.com/actions/cache/releases/tag/v4.3.0
        with:
          path: ${{ github.workspace }}/.compiled-mdx
          key: ${{ runner.os }}-compiled-mdx-${{ hashFiles('src/app/content/**/*.mdx', 'src/lib/shiki/*.json') }}
          restore-keys: |
            ${{ runner.os }}-compiled-mdx-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Precompile MDX
        run: pnpm precompile-mdx

      - name: Upload Compiled MDX to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          ENDPOINT: https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
          COMPILED_DIR: .compiled-mdx
          CONTENT_DIR: src/app/content
          CONTENT_PREFIX: compiled-mdx
        run: |
          CONTENT_PREFIX=${CONTENT_PREFIX:-compiled-mdx}
          S3_PREFIX="s3://${{ secrets.R2_BUCKET }}/$CONTENT_PREFIX"

          # Size-only sync first (handles new files, size changes, and deletions efficiently)
          aws s3 sync "$COMPILED_DIR/" "$S3_PREFIX" \
            --endpoint-url "$ENDPOINT" \
            --no-progress \
            --size-only \
            --delete \
            --content-type "application/json"

          # Then force-upload any files changed in this commit (catches same-size content edits)
          # Skip if this is the first commit
          if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            changed_files=$(git diff --name-only --diff-filter=ACM HEAD^ "$CONTENT_DIR/" | grep '\.mdx$' || echo "")

            for file in $changed_files; do
              # Convert .mdx path to .json path in compiled directory
              relative_path="${file#$CONTENT_DIR/}"
              json_path="${relative_path%.mdx}.json"
              compiled_file="$COMPILED_DIR/$json_path"

              if [ -f "$compiled_file" ]; then
                aws s3 cp "$compiled_file" "$S3_PREFIX/$json_path" \
                  --endpoint-url "$ENDPOINT" \
                  --no-progress \
                  --content-type "application/json"
              fi
            done
          fi

      - name: Build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_CHALLENGE_SECRET: ${{ secrets.NEXT_PUBLIC_CHALLENGE_SECRET }}
          NEXT_PUBLIC_CHALLENGE_RPC_ENDPOINT: ${{ secrets.NEXT_PUBLIC_CHALLENGE_RPC_ENDPOINT }}
          NEXT_PUBLIC_RPC_ENDPOINT: ${{ secrets.NEXT_PUBLIC_RPC_ENDPOINT }}
        run: pnpm exec opennextjs-cloudflare build

      - name: Deploy
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # https://github.com/cloudflare/wrangler-action/releases/tag/v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  preview:
    if: github.ref != 'refs/heads/master'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # https://github.com/actions/checkout/releases/tag/v6.0.0
        with:
          fetch-depth: 2

      - name: Install pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # https://github.com/pnpm/action-setup/releases/tag/v4.2.0
        with:
          version: 10
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # https://github.com/actions/setup-node/releases/tag/v6.0.0
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Cache Next.js
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # https://github.com/actions/cache/releases/tag/v4.3.0
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-

      - name: Cache Compiled MDX
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # https://github.com/actions/cache/releases/tag/v4.3.0
        with:
          path: ${{ github.workspace }}/.compiled-mdx
          key: ${{ runner.os }}-compiled-mdx-${{ hashFiles('src/app/content/**/*.mdx', 'src/lib/shiki/*.json') }}
          restore-keys: |
            ${{ runner.os }}-compiled-mdx-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Precompile MDX
        run: pnpm precompile-mdx

      - name: Derive preview content prefix
        run: |
          BRANCH_SLUG=$(echo "${GITHUB_REF_NAME}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//; s/-$//')
          echo "CONTENT_PREFIX=compiled-mdx-preview/${BRANCH_SLUG:-preview}" >> "$GITHUB_ENV"

      - name: Upload Compiled MDX to R2 (preview)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          ENDPOINT: https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com
          COMPILED_DIR: .compiled-mdx
          CONTENT_DIR: src/app/content
        run: |
          CONTENT_PREFIX=${CONTENT_PREFIX:-compiled-mdx-preview}
          S3_PREFIX="s3://${{ secrets.R2_BUCKET }}/$CONTENT_PREFIX"

          # Size-only sync first (handles new files, size changes, and deletions efficiently)
          aws s3 sync "$COMPILED_DIR/" "$S3_PREFIX" \
            --endpoint-url "$ENDPOINT" \
            --no-progress \
            --size-only \
            --delete \
            --content-type "application/json"

          # Then force-upload any files changed in this commit (catches same-size content edits)
          # Skip if this is the first commit
          if git rev-parse --verify HEAD^ >/dev/null 2>&1; then
            changed_files=$(git diff --name-only --diff-filter=ACM HEAD^ "$CONTENT_DIR/" | grep '\.mdx$' || echo "")

            for file in $changed_files; do
              # Convert .mdx path to .json path in compiled directory
              relative_path="${file#$CONTENT_DIR/}"
              json_path="${relative_path%.mdx}.json"
              compiled_file="$COMPILED_DIR/$json_path"

              if [ -f "$compiled_file" ]; then
                aws s3 cp "$compiled_file" "$S3_PREFIX/$json_path" \
                  --endpoint-url "$ENDPOINT" \
                  --no-progress \
                  --content-type "application/json"
              fi
            done
          fi

      - name: Build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_CHALLENGE_SECRET: ${{ secrets.NEXT_PUBLIC_CHALLENGE_SECRET }}
          NEXT_PUBLIC_CHALLENGE_RPC_ENDPOINT: ${{ secrets.NEXT_PUBLIC_CHALLENGE_RPC_ENDPOINT }}
          NEXT_PUBLIC_RPC_ENDPOINT: ${{ secrets.NEXT_PUBLIC_RPC_ENDPOINT }}
        run: pnpm exec opennextjs-cloudflare build

      - name: Deploy Preview
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # https://github.com/cloudflare/wrangler-action/releases/tag/v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env preview --var CONTENT_PREFIX:${{ env.CONTENT_PREFIX }}
